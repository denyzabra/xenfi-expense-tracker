'use client';

import { useEffect, useState } from 'react';
import Dashboard from '@/components/Dashboard';
import TransactionModal from '@/components/TransactionModal';
import { Transaction, Category, TransactionType, Expense } from '@/types';
import { api } from '@/lib/utils/api-client';
import { useAuth } from '@/components/providers/AuthProvider';
import { useTransactionModal } from '@/components/providers/TransactionModalProvider';
import { useRouter } from 'next/navigation';

export default function DashboardPage() {
  const { isAuthenticated, loading: authLoading } = useAuth();
  const { isModalOpen, editingTransaction, closeModal } = useTransactionModal();
  const router = useRouter();
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [categories, setCategories] = useState<Category[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!authLoading && !isAuthenticated) {
      router.push('/login');
    }
  }, [isAuthenticated, authLoading, router]);

  useEffect(() => {
    if (isAuthenticated) {
      fetchData();
    }
  }, [isAuthenticated]);

  const fetchData = async () => {
    try {
      setLoading(true);
      const [expensesRes, categoriesRes] = await Promise.all([
        api.get<{ status: string; data: { expenses: Expense[] } }>('/expenses'),
        api.get<{ status: string; data: { categories: Category[] } }>('/categories'),
      ]);

      // Convert Expense[] to Transaction[]
      const transactionsData: Transaction[] = expensesRes.data.expenses.map((expense) => ({
        ...expense,
        type: TransactionType.EXPENSE,
      }));

      setTransactions(transactionsData);
      setCategories(categoriesRes.data.categories);
    } catch (error) {
      console.error('Error fetching data:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSaveTransaction = async (transactionData: Omit<Transaction, 'id'> & { id?: string }) => {
    try {
      if (transactionData.id) {
        // Update existing transaction
        await api.put(`/expenses/${transactionData.id}`, {
          amount: transactionData.amount,
          description: transactionData.description,
          categoryId: transactionData.categoryId,
          date: transactionData.date,
          paymentMethod: transactionData.paymentMethod,
          attachmentUrl: transactionData.attachmentUrl,
        });
      } else {
        // Create new transaction
        await api.post('/expenses', {
          amount: transactionData.amount,
          description: transactionData.description,
          categoryId: transactionData.categoryId,
          date: transactionData.date,
          paymentMethod: transactionData.paymentMethod,
          attachmentUrl: transactionData.attachmentUrl,
        });
      }

      await fetchData();
      closeModal();
    } catch (error) {
      console.error('Error saving transaction:', error);
      alert('Failed to save transaction. Please try again.');
    }
  };

  if (authLoading || loading) {
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="w-8 h-8 border-4 border-primary/30 border-t-primary rounded-full animate-spin"></div>
      </div>
    );
  }

  if (!isAuthenticated) {
    return null;
  }

  return (
    <>
      <Dashboard transactions={transactions} categories={categories} />
      <TransactionModal
        isOpen={isModalOpen}
        onClose={closeModal}
        onSave={handleSaveTransaction}
        categories={categories}
        editingTransaction={editingTransaction}
      />
    </>
  );
}
